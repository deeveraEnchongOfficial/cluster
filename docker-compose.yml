services:
  app:
    build:
      context: ./workspace/docker/php8.3
      dockerfile: Dockerfile
      args:
        WWWGROUP: '${WWWGROUP}'
    extra_hosts:
      - 'integrations.thesalesmachine.test:host-gateway'
    environment:
      WWWUSER: '${WWWUSER}'
      XDEBUG_MODE: '${TSM_INTEGRATIONS_XDEBUG_MODE:-off}'
      XDEBUG_CONFIG: '${TSM_INTEGRATIONS_XDEBUG_CONFIG:-client_host=integrations.thesalesmachine.test}'
      IGNITION_LOCAL_SITES_PATH: '${PWD}'
    volumes:
      - './:/var/www/html'
      - '/var/run/docker.sock:/var/run/docker.sock'
    ports:
      - '8000:80'
    networks:
      - tsm-integrations-net
    depends_on:
      - redis
      - mailhog
      - mongo

  mongo:
    image: 'mongo'
    command: ["mongod", "--replSet", "dev", "--bind_ip_all", "--port", "27017", "--keyFile", "/data/replicaset.key"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: '${MONGODB_USERNAME:-dbuser}'
      MONGO_INITDB_ROOT_PASSWORD: '${MONGODB_PASSWORD:-password}'
    volumes:
      - 'tsm-integrations-mongodb:/data/mdb'
      - './workspace/docker/mongodb/replicaset.key:/data/replicaset.dev.key'
    entrypoint:
      - bash
      - -c
      - |
        cp /data/replicaset.dev.key /data/replicaset.key
        chmod 400 /data/replicaset.key
        chown 999:999 /data/replicaset.key
        exec docker-entrypoint.sh $$@
    ports:
      - '${TSM_INTEGRATIONS_MONGO_PORT:-27017}:27017'
    networks:
      - tsm-integrations-net

  redis:
    image: 'redis:alpine'
    ports:
      - '${TSM_INTEGRATIONS_REDIS_PORT:-63790}:6379'
    volumes:
      - 'tsm-integrations-redis:/data'
    networks:
      - tsm-integrations-net
    healthcheck:
      test:
        - CMD
        - redis-cli
        - ping
      retries: 3
      timeout: 5s

  mailhog:
    image: 'mailhog/mailhog:latest'
    ports:
      - '${TSM_INTEGRATIONS_MAILHOG_DASHBOARD_PORT:-9025}:8025'
    networks:
      - tsm-integrations-net

networks:
  tsm-integrations-net:
    driver: bridge
volumes:
  tsm-integrations-redis:
    driver: local
  tsm-integrations-mongodb:
    driver: local
